name: Test formula

on:
  pull_request:
    types:
      - labeled

jobs:

  build:
    name: Test formula
    runs-on: ubuntu-20.04
    steps:

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get PR number
        id: get-pr-number
        run: |
          PR=$(echo "${GITHUB_REF}" | cut -d'/' -f3)
          echo "Running for PR #${PR}"
          echo "::set-output name=pr-number::${PR}"

      - name: Check for label
        id: check-label
        run: |
          PR="${{ steps.get-pr-number.outputs.pr-number }}"
          echo "Running for PR #${PR}"

          LABELS=$(
              curl "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR}" \
                      --silent \
                      --location | \
                  jq --raw-output '.labels[].name'
          )
          IS_READY_FOR_TESTING=false
          for LABEL in ${LABELS}; do
              if test "${LABEL}" == "ready-for/testing"; then
                  IS_READY_FOR_TESTING=true
                  echo "Found label ready-for/testing"
                  echo "::set-output name=is-ready-for-testing::${IS_READY_FOR_TESTING}"
                  break
              fi
          done

      - name: Test formula
        id: test-formula
        if: ${{ steps.check-renovate-label.outputs.is-renovate-pr }} == "true"
        run: |
          PR="${{ steps.get-pr-number.outputs.pr-number }}"
          echo "Running for PR #${PR}"

          FILES=$(
              curl "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR}/files" \
                      --silent \
                      --location \
                      --header 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' | \
                  jq --raw-output '.[].filename'
          )
          STARTS_WITH="Formula/"
          for FILE in ${FILES}; do
              if test "${FILE:0:${#STARTS_WITH}}" == "${STARTS_WITH}"; then
                  FORMULA="$(basename "${FILE}" .rb)"

                  echo "Running tests for ${FORMULA}"
                  bash scripts/test.sh "${FORMULA}"
              fi
          done

      - name: Label PR
        id: label-pr
        run: |
          PR="${{ steps.get-pr-number.outputs.pr-number }}"
          echo "Running for PR #${PR}"

          echo "Adding label ready-for/review"
          curl "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR}/labels" \
              --request "POST" \
              --header "Accept: application/vnd.github.v3+json" \
              --header 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
              --data '{ "labels": [ "ready-for/review" ] }'

      - name: Remove label from PR
        id: unlabel-pr
        if: ${{ failure() }}
        run: |
          PR="${{ steps.get-pr-number.outputs.pr-number }}"
          echo "Running for PR #${PR}"

          echo "Adding label ready-for/testing"
          curl "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR}/labels/ready-for/testing" \
              --request "DELETE" \
              --header "Accept: application/vnd.github.v3+json" \
              --header 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}'
